(self.webpackChunkasany_admin=self.webpackChunkasany_admin||[]).push([[4782],{54782:function(_e,V,i){"use strict";var Q=i(86582),B=i(2824),b=i(11849),x=i(39428),z=i(91220),Z=i(3182),c=i(67294),O=i(28865),D=i(5618),g=i(32669),n=i(38671),H=i(36321),R=i(54108),G=i(25496),e=i(85893),k={validator:function(j,v){return(0,Z.Z)((0,x.Z)().mark(function s(){var f,N,d;return(0,x.Z)().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:f=(0,z.Z)(v),l.prev=1,f.s();case 3:if((N=f.n()).done){l.next=9;break}if(d=N.value,!(0,D.Le)(d)){l.next=7;break}throw new Error("\u7535\u5B50\u90AE\u4EF6\u5730\u5740\u65E0\u6548");case 7:l.next=3;break;case 9:l.next=14;break;case 11:l.prev=11,l.t0=l.catch(1),f.e(l.t0);case 14:return l.prev=14,f.f(),l.finish(14);case 17:case"end":return l.stop()}},s,null,[[1,11,14,17]])}))()}};function F(u){return(0,e.jsx)(D.ZP,(0,b.Z)({className:"email-tags-input border-0 form-control form-control-transparent",validate:D.Le,parseTag:D.N8},u))}function X(u){return(0,e.jsx)(n.Bn,(0,b.Z)({},u))}function w(u){var j;if(!u)return{sending:!1,mode:"plain",disabled:!0,autoSaveState:"default",recipients:[],title:""};var v=[];return u.cc.length&&v.push("cc"),u.bcc.length&&v.push("bcc"),{message:u,sending:!1,disabled:!u.to||!u.to.length,autoSaveState:"default",title:u.subject,recipients:v,mode:(j=u.mimeType)!==null&&j!==void 0&&j.endsWith("html")?"html":"plain"}}function Y(u){var j=u.onAutoSave,v=u.onSend,s=(0,c.useRef)(w(u.message)),f=(0,c.useReducer)(function(r){return r+1},0),N=(0,B.Z)(f,2),d=N[1],U=(0,g.gi)({refetchQueries:[g.Nd]}),l=(0,B.Z)(U,1),J=l[0],q=(0,g.qX)({refetchQueries:[g.Nd]}),ee=(0,B.Z)(q,1),ae=ee[0],se=(0,g.do)({refetchQueries:[g.Nd]}),re=(0,B.Z)(se,1),L=re[0],ne=(0,H.Qk)(function(){var r=(0,Z.Z)((0,x.Z)().mark(function t(_,h){var M,A,E,p,m;return(0,x.Z)().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(M=s.current.message,M){a.next=9;break}return a.next=4,J({variables:{input:h}});case 4:A=a.sent,E=A.data,s.current.message=E==null?void 0:E.message,a.next=14;break;case 9:return a.next=11,ae({variables:{id:M.id,input:h}});case 11:p=a.sent,m=p.data,s.current.message=m==null?void 0:m.message;case 14:j(s.current.message);case 15:case"end":return a.stop()}},t)}));return function(t,_){return r.apply(this,arguments)}}(),s.current.message||{}),K=(0,B.Z)(ne,2),P=K[0],T=K[1],o=n.l0.useForm(),I=(0,c.useRef)(null),S=(0,c.useCallback)(function(r){return function(){s.current.recipients.includes(r)?s.current.recipients=s.current.recipients.filter(function(t){return t!=r}):s.current.recipients=[].concat((0,Q.Z)(s.current.recipients),[r]),d()}},[]),ue=(0,c.useCallback)(function(){var r=s.current.mode=="plain"?"html":"plain",t=o.getFieldValue("body");r=="plain"?o.setFieldsValue({body:(0,R.Kv)(t,{text:"format"})}):o.setFieldsValue({body:(0,R.vb)(t)}),s.current.mode=r;var _=o.getFieldsValue();P((0,b.Z)((0,b.Z)({},_),{},{mimeType:"text/".concat(s.current.mode)}))},[o,P]);(0,c.useEffect)(function(){if(s.current.mode!="plain"){var r=document.querySelector(".ql-toolbar");r==null||r.classList.add("px-5","border-top-0","border-start-0","border-end-0");var t=document.querySelector(".ql-container");t==null||t.classList.add("bg-transparent","border-0","px-3","ql-snow")}},[s.current.mode]);var te=(0,c.useCallback)(function(r){var t;(t=I.current)===null||t===void 0||t.browse(r)},[]),le=(0,c.useCallback)(function(r,t){console.log("changedValues",r),r.hasOwnProperty("subject")&&(s.current.title=r.subject,d()),r.hasOwnProperty("to")&&(!r.to||!r.to.length?s.current.disabled||(s.current.disabled=!0,d()):s.current.disabled&&(s.current.disabled=!1,d())),P((0,b.Z)((0,b.Z)({},t),{},{mimeType:"text/".concat(s.current.mode)}))},[P]),ie=(0,c.useCallback)((0,Z.Z)((0,x.Z)().mark(function r(){var t,_,h,M,A,E,p,m;return(0,x.Z)().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(t=I.current)===null||t===void 0?void 0:t.uploadAll();case 2:return a.prev=2,a.next=5,o.validateFields();case 5:if(_=a.sent,!(!_.subject||!_.body)){a.next=15;break}return h=[],_.subject||h.push("\u4E3B\u9898"),_.body||h.push("\u6B63\u6587"),a.next=12,n.u_.confirm({title:"\u6B64\u90AE\u4EF6\u6CA1\u6709"+h.join("\u548C"),content:"\u662F\u5426\u4ECD\u8981\u53D1\u9001\u90AE\u4EF6\uFF1F",okText:"\u4ECD\u7136\u53D1\u9001"});case 12:if(M=a.sent,M.isConfirmed){a.next=15;break}return a.abrupt("return");case 15:return s.current.sending=!0,d(),a.prev=17,a.next=20,(0,G.gw)(L({variables:{id:s.current.message.id}}),350);case 20:A=a.sent,n.u_.success({title:"\u64CD\u4F5C\u6210\u529F",content:"\u90AE\u4EF6\u5DF2\u6210\u529F\u53D1\u9001",timer:3e3}),v(A.data.message),a.next=30;break;case 25:a.prev=25,a.t0=a.catch(17),s.current.sending=!1,d(),n.u_.error({title:"\u9519\u8BEF",content:a.t0.message});case 30:a.next=38;break;case 32:a.prev=32,a.t1=a.catch(2),E=a.t1,p=E.errorFields[0],p.name.includes("to")?m="\u201C\u6536\u4EF6\u4EBA\uFF1A\u201D\u5B57\u6BB5\u4E2D\u7684\u4E00\u4E2A\u6216\u591A\u4E2A\u5730\u5740\u65E0\u6548\u3002\u8BF7\u5728\u7EA0\u6B63\u540E\u91CD\u8BD5\u3002":p.name.includes("cc")?m="\u201C\u6284\u9001\uFF1A\u201D\u5B57\u6BB5\u4E2D\u7684\u4E00\u4E2A\u6216\u591A\u4E2A\u5730\u5740\u65E0\u6548\u3002\u8BF7\u5728\u7EA0\u6B63\u540E\u91CD\u8BD5\u3002":p.name.includes("bcc")?m="\u201C\u5BC6\u9001\uFF1A\u201D\u5B57\u6BB5\u4E2D\u7684\u4E00\u4E2A\u6216\u591A\u4E2A\u5730\u5740\u65E0\u6548\u3002\u8BF7\u5728\u7EA0\u6B63\u540E\u91CD\u8BD5\u3002":m="\u8BF7\u5728\u7EA0\u6B63\u540E\u91CD\u8BD5\u3002",n.u_.error({title:p.errors[0],content:m});case 38:case"end":return a.stop()}},r,null,[[2,32],[17,25]])})),[o,v,L]);(0,c.useMemo)(function(){return T?s.current.autoSaveState="saving":s.current.autoSaveState!="default"?s.current.autoSaveState="saved":s.current.autoSaveState},[T]),(0,c.useEffect)(function(){var r;!u.message||u.message.id==((r=s.current.message)===null||r===void 0?void 0:r.id)||(s.current=w(u.message),o.setFieldsValue((0,b.Z)({},u.message)),d())},[o,u.message]);var y=s.current,ce=y.message,C=y.recipients,de=y.mode,W=y.autoSaveState,oe=y.disabled,$=y.sending;return console.log("recipients",C),(0,e.jsxs)(n.Zb,{className:"email-compose-editor",children:[(0,e.jsxs)(n.Zb.Header,{children:[(0,e.jsx)(n.Zb.Title,{children:s.current.title||"\u65B0\u4FE1\u606F"}),(0,e.jsxs)(n.Zb.Toolbar,{className:"text-gray-600",children:[W=="saving"&&"\u6B63\u5728\u5B58\u50A8\u8349\u7A3F...",W=="saved"&&"\u5DF2\u5B58\u50A8"]})]}),(0,e.jsx)(n.Zb.Body,{className:"p-0",children:(0,e.jsxs)(n.l0,{form:o,initialValues:(0,b.Z)({},ce||{}),onValuesChange:le,id:"kt_inbox_compose_form",children:[(0,e.jsxs)("div",{className:"email-compose-editor-body",children:[(0,e.jsxs)("div",{className:"d-flex align-items-center border-bottom px-8 min-h-45px",children:[(0,e.jsx)("div",{className:"text-dark fw-bolder w-75px",children:"\u6536\u4EF6\u4EBA:"}),(0,e.jsx)(n.l0.Item,{noStyle:!0,name:"to",rules:[k],children:(0,e.jsx)(F,{placeholder:"\u8F93\u5165\u6536\u4EF6\u4EBA\u90AE\u7BB1"})}),(0,e.jsxs)("div",{className:"ms-auto w-75px text-end",children:[!C.includes("cc")&&(0,e.jsx)("span",{onClick:S("cc"),className:"text-muted fs-bold cursor-pointer text-hover-primary me-2",children:"\u6284\u9001"}),!C.includes("bcc")&&(0,e.jsx)("span",{onClick:S("bcc"),className:"text-muted fs-bold cursor-pointer text-hover-primary",children:"\u5BC6\u9001"})]})]}),C.includes("cc")&&(0,e.jsxs)("div",{className:"align-items-center border-bottom ps-8 pe-5 min-h-45px d-flex",children:[(0,e.jsx)("div",{className:"text-dark fw-bolder w-75px",children:"\u6284\u9001:"}),(0,e.jsx)(n.l0.Item,{noStyle:!0,name:"cc",rules:[k],children:(0,e.jsx)(F,{placeholder:"\u8F93\u5165\u6284\u9001\u90AE\u7BB1"})}),(0,e.jsx)("span",{className:"btn btn-clean btn-xs btn-icon",onClick:S("cc"),children:(0,e.jsx)("i",{className:"la la-close"})})]}),C.includes("bcc")&&(0,e.jsxs)("div",{className:"align-items-center border-bottom inbox-to-bcc ps-8 pe-5 min-h-45px d-flex",children:[(0,e.jsx)("div",{className:"text-dark fw-bolder w-75px",children:"\u5BC6\u9001:"}),(0,e.jsx)(n.l0.Item,{noStyle:!0,name:"bcc",rules:[k],children:(0,e.jsx)(F,{placeholder:"\u8F93\u5165\u5BC6\u9001\u90AE\u7BB1"})}),(0,e.jsx)("span",{className:"btn btn-clean btn-xs btn-icon",onClick:S("bcc"),children:(0,e.jsx)("i",{className:"la la-close"})})]}),(0,e.jsxs)("div",{className:"d-flex align-items-center border-bottom px-8 min-h-45px",children:[(0,e.jsx)("div",{className:"text-dark fw-bolder w-75px",children:"\u4E3B\u9898:"}),(0,e.jsx)(n.l0.Item,{noStyle:!0,name:"subject",children:(0,e.jsx)(n.II,{className:"border-0 min-h-45px",placeholder:"\u8F93\u5165\u4E3B\u9898",transparent:!0})})]}),(0,e.jsx)(n.l0.Item,{noStyle:!0,name:"body",children:(0,e.jsx)(X,{mode:de})}),(0,e.jsx)(n.l0.Item,{noStyle:!0,name:"attachments",children:(0,e.jsx)(n.gq.Queue,{className:"px-8 py-4",auto:!0,ref:I,namespace:"email"})})]}),(0,e.jsxs)("div",{className:"d-flex flex-stack flex-wrap gap-2 py-5 ps-8 pe-5 border-top",children:[(0,e.jsx)("div",{className:"d-flex align-items-center me-3",children:(0,e.jsx)("div",{className:"btn-group me-4",children:(0,e.jsx)(n.zx,{htmlType:"button",loading:$,size:"lg",className:"rounded-2 fs-bold px-10",variant:"primary",icon:(0,e.jsx)(O.ZP,{name:"Duotune/gen016",className:"svg-icon-1 ms-n4 me-4"}),disabled:T||oe,onClick:ie,children:$?"\u53D1\u9001\u4E2D...":"\u53D1\u9001"})})}),(0,e.jsxs)("div",{className:"d-flex align-items-center",children:[(0,e.jsx)(n.u,{title:"\u6DFB\u52A0\u9644\u4EF6",placement:"top",children:(0,e.jsx)("span",{onClick:te,className:"btn btn-icon btn-sm btn-clean btn-active-light-primary me-2 dz-clickable",children:(0,e.jsx)(O.ZP,{className:"svg-icon-2 m-0",name:"Duotune/com008"})})}),(0,e.jsx)(n.u,{title:"\u5207\u6362\u7F16\u8F91\u5668",placement:"top",children:(0,e.jsx)(n.zx,{as:"span",variant:"clean",activeColor:"light-primary",className:"btn-clean",icon:(0,e.jsx)(O.ZP,{className:"svg-icon-2",name:"Duotune/art001"}),onClick:ue})})]})]})]})})]})}V.Z=Y}}]);
