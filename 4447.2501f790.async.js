(self.webpackChunkasany_admin=self.webpackChunkasany_admin||[]).push([[4447],{14447:function(Me,L,n){"use strict";n.r(L);var xe=n(3515),ee=n(86288),ae=n(93224),te=n(3182),v=n(11849),P=n(2824),ne=n(94043),B=n.n(ne),r=n(67294),se=n(94184),le=n.n(se),re=n(30381),f=n.n(re),ie=n(73727),ue=n(89887),b=n(33043),K=n(8845),de=n(75468),i=n(53704),W=n(25496),t=n(85893);function _e(F){var $=F.match.params,oe=$.cid,M=$.id,x=F.location.state,ce=x.rootCategoryId,u=x.categories,Z=x.baseUrl,S=(0,r.useRef)(null),d=(0,r.useRef)({publishedAt:f()()}),me=(0,r.useReducer)(function(e){return e+1},0),ve=(0,P.Z)(me,2),N=ve[1],_=i.l0.useForm(),k=(0,K.V7)({fetchPolicy:"cache-and-network",variables:{id:M}}),O=k.data,he=k.loading,a=O==null?void 0:O.article,fe=(0,r.useMemo)(function(){return!u||!u.length?[]:(0,W.G_)(u.map(function(e){return(0,v.Z)((0,v.Z)({},e),{},{value:e.id,title:e.name})}),{idKey:"id",childrenKey:"children",pidKey:"parent.id",sort:function(s,l){return s.index-l.index}})},[u]),Ee=(0,K.Mq)(),H=(0,P.Z)(Ee,2),G=H[0],C=H[1].loading,be=(0,r.useState)(),Q=(0,P.Z)(be,2),pe=Q[0],V=Q[1],Ae=(0,r.useCallback)(function(e){var s,l=u.find(function(o){return o.id==e});V(l==null||(s=l.storeTemplate)===null||s===void 0?void 0:s.id)},[u]);(0,r.useEffect)(function(){var e,s;!u||!u.length||!a||V((e=u.find(function(l){var o;return l.id==((o=a.category)===null||o===void 0?void 0:o.id)}))===null||e===void 0||(s=e.storeTemplate)===null||s===void 0?void 0:s.id)},[a,u]);var p=(0,r.useCallback)(function(){var e=(0,te.Z)(B().mark(function s(l){var o,h,A,z,w,T,j,J,R,D,U,E,g,I,y,c,X,q;return B().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return d.current.action=l,m.next=3,(o=S.current)===null||o===void 0?void 0:o.uploadAll();case 3:return m.next=5,_.validateFields();case 5:for(h=m.sent,A=h.meta,z=h.category,w=h.body,T=h.publishedAt,j=(0,ae.Z)(h,["meta","category","body","publishedAt"]),J={seo_title:"single_line_text_field",seo_description:"multi_line_text_field",seo_keywords:"list.single_line_text_field"},R=[],D=0,U=Object.keys(A);D<U.length;D++)for(E=U[D],g=0,I=Object.keys(A[E]);g<I.length;g++)y=I[g],R.push({namespace:E,key:y,value:A[E][y],type:J[E+"_"+y]});return c=(0,v.Z)((0,v.Z)({},j),{},{metafields:R,category:z.id,body:{type:"HTML",text:w.text}}),l=="publish"?c.status="PUBLISHED":l=="schedule"||l=="reschedule"?(c.status="SCHEDULED",c.publishedAt=T):l=="unpublish"||l=="revert_to_draft"?c.status="DRAFT":l=="update"&&(c.status=a==null?void 0:a.status,c.publishedAt=T),X=G({variables:{id:M,input:c}}),m.next=19,i.FN.promise((0,W.gw)(X,350),{pending:"\u63D0\u4EA4\u4E2D...",success:"\u201C".concat(j.title,"\u201D \u4FDD\u5B58\u6210\u529F"),error:"\u63D0\u4EA4\u51FA\u9519"},{duration:2e3,placement:"top-center"});case 19:q=m.sent,console.log("submit result set",q);case 21:case"end":return m.stop()}},s)}));return function(s){return e.apply(this,arguments)}}(),[_,G,M,a==null?void 0:a.status]),Y=d.current.publishedAt,De=(0,r.useCallback)(function(e){d.current.publishedAt=e,_.setFieldsValue({publishedAt:e}),N()},[_]);(0,r.useEffect)(function(){var e;!a||(a.publishedAt&&(d.current.publishedAt=f()(a.publishedAt)),d.current.article=a,_.setFieldsValue((0,v.Z)((0,v.Z)({},a),{},{publishedAt:d.current.publishedAt,image:(e=a.image)===null||e===void 0?void 0:e.id})))},[a,_]);var ge=(0,r.useCallback)(function(){p("update")},[p]),ye=(0,r.useCallback)(function(e){p(e)},[p]),Pe=(0,r.useCallback)(function(){var e=d.current.article,s=e!=null&&e.publishedAt?f()(e.publishedAt):f()();d.current.publishedAt=s,N(),_.setFieldsValue({publishedAt:s})},[_]);return console.log("storeTemplate",pe,Y),(0,t.jsx)(de.v,{loading:he,header:{title:"\u7F16\u8F91\u6587\u7AE0"},breadcrumb:(0,t.jsx)(i.aG,{className:"fw-bold fs-base text-muted my-1",children:a?(0,t.jsxs)(t.Fragment,{children:[a.categories.filter(function(e){return e.id!=ce}).map(function(e){return(0,t.jsx)(i.aG.Item,{children:(0,t.jsx)(ie.Link,{to:"".concat(Z,"/cms/categories/").concat(e.id,"/articles"),className:"text-muted",children:e.name})},e.id)}),(0,t.jsx)(i.aG.Item,{className:"text-dark",children:a==null?void 0:a.title})]}):(0,t.jsx)(i.aG.Item,{children:"\u52A0\u8F7D\u4E2D..."})}),children:(0,t.jsxs)(i.l0,{form:_,initialValues:{status:"DRAFT",channel:oe},className:"form d-flex flex-column flex-lg-row",children:[(0,t.jsxs)("div",{className:"d-flex flex-column flex-row-fluid gap-7 gap-lg-10  me-lg-10",children:[(0,t.jsxs)(i.mQ,{defaultActiveKey:"general",renderContainer:!1,className:"border-0 fs-4 fw-bold mb-n2 nav-line-tabs-2x",children:[(0,t.jsx)(i.mQ.TabPane,{tab:"\u57FA\u672C\u4FE1\u606F",forceRender:!0,children:(0,t.jsx)(b.LQ,{queueUpload:S})},"general"),(0,t.jsx)(i.mQ.TabPane,{tab:"\u9AD8\u7EA7\u8BBE\u7F6E",forceRender:!0,children:(0,t.jsx)(b.aE,{})},"advanced"),(0,t.jsx)(i.mQ.TabPane,{tab:"\u5143\u6570\u636E",forceRender:!0,children:(0,t.jsx)(b.SF,{})},"meta")]}),(0,t.jsx)(ee.Z,{offsetBottom:16,children:(0,t.jsxs)("div",{className:le()("d-flex bg-body-color p-5 mx-4 tw-rounded-2xl align-items-center"),children:[(0,t.jsx)("div",{className:"text-primary flex-row-fluid",children:(a==null?void 0:a.status)=="SCHEDULED"&&(0,t.jsxs)(t.Fragment,{children:["\u5C06\u4E8E ",f()(a.publishedAt).format("YYYY \u5E74 MM \u6708 DD \u65E5 HH:mm")," \u53D1\u5E03"]})}),(a==null?void 0:a.status)=="DRAFT"&&(0,t.jsx)(i.zx,{variant:"light",loading:d.current.action=="update"&&C,onClick:ge,className:"me-5",children:d.current.action=="update"&&C?"\u4FDD\u5B58\u4E2D...":"\u4FDD\u5B58\u8349\u7A3F"}),(0,t.jsx)(b.H5,{article:a,onPublish:ye,publishedAt:Y,submitting:C,setPublishedAt:De,onCancel:Pe})]})})]}),(0,t.jsx)(ue.Z,{baseUrl:Z,article:a,categoryTreeData:fe,onChangeCategory:Ae})]})})}L.default=_e}}]);
