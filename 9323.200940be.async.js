(self.webpackChunkasany_admin=self.webpackChunkasany_admin||[]).push([[9323],{99323:function(Oe,O,d){"use strict";d.r(O),d.d(O,{ArticleEdit:function(){return xe},ArticleNew:function(){return he},default:function(){return ge}});var U=d(3182),v=d(11849),N=d(2824),_=d(94043),k=d.n(_),n=d(67294),F=d(28865),ee=d(94184),K=d.n(ee),L=d(62313),ae=d(82949),te=d.n(ae),D=d(64458),ne=d(72757),Q=d(35145),e=d(85893),re=n.forwardRef(function(i,u){var o=i.onWordCount,h=i.container,m=i.value,p=i.onChange,y=i.editor,E=y===void 0?"BalloonBlock":y,w=(0,n.useRef)(m);w.current=m;var M=(0,n.useMemo)(function(){if(E=="BalloonBlockEditor")return Q.BalloonBlockEditor;if(E=="ClassicEditor")return Q.ClassicEditor},[E]),S=(0,n.useCallback)(function(g){if(!!(g!=null&&g.ui)){var B=g.plugins.get("WordCount");o&&o(B);var j=g.ui.view.body._bodyCollectionContainer;g.ui.view.element=h.current,j.remove(),g.ui.view.element.appendChild(j),typeof u=="function"?u(g):u.hasOwnProperty("current")&&(u.current=g)}},[]),x=(0,n.useCallback)(function(g,B){var j=B.getData();if(j!=w.current&&!(!w.current&&!j)){var W=B.plugins.get("WordCount");o&&o(W),p&&p(j)}},[]);return(0,e.jsx)(ne.CKEditor,{editor:M,data:m,config:{language:"zh-cn"},onReady:S,onChange:x})});function se(r,i){var u=r.editor,o=u===void 0?"BalloonBlockEditor":u,h=(0,n.useState)(!1),m=(0,N.Z)(h,2),p=m[0],y=m[1];return(0,n.useEffect)(function(){y(!0);var E=setTimeout(function(){y(!1)},250);return function(){clearTimeout(E)}},[o]),p?(0,e.jsx)("div",{children:"switching..."}):o=="BalloonBlockEditor"||o=="ClassicEditor"?(0,e.jsx)(re,(0,v.Z)((0,v.Z)({},r),{},{ref:i})):(0,e.jsxs)("div",{children:["\u672A\u5B9E\u73B0\u7F16\u8F91\u5668: ",o]})}var le=n.forwardRef(se),ie=le,a=d(11974);function ue(r){var i=r.onConfirm,u=r.onCancel;return(0,e.jsxs)(a.u_,{centered:!0,visible:!0,onCancel:u,cancelText:"\u7559 \u4E0B",onOk:i,footer:null,okText:"\u79BB \u5F00",dialogClassName:"mw-550px",bodyClassName:"mx-5 pt-0 pb-15",children:[(0,e.jsx)("div",{className:"mb-6",children:(0,e.jsx)("h1",{className:"mb-3",children:"\u4F60\u786E\u5B9A\u8981\u79BB\u5F00\u5F53\u524D\u9875\u9762\u5417?"})}),(0,e.jsx)("div",{className:"mb-6",children:(0,e.jsxs)("div",{className:"mh-375px scroll-y me-n7 pe-7 fs-6 text-muted",children:[(0,e.jsx)("p",{children:" \u60A8\u6709\u6B63\u5728\u7F16\u8F91\u7684\u5185\u5BB9, \u4F46\u672A\u4FDD\u5B58."}),(0,e.jsx)("p",{children:"\u5728\u79BB\u5F00\u524D, \u5148\u4FDD\u5B58\u60A8\u7684\u4FEE\u6539"})]})}),(0,e.jsxs)("div",{className:"d-flex justify-content-between",children:[(0,e.jsx)("div",{className:"fw-bold"}),(0,e.jsxs)("div",{children:[(0,e.jsx)(a.zx,{variant:"light",className:"me-3",onClick:u,children:"\u7559\u5728\u5F53\u524D\u9875\u9762"}),(0,e.jsx)(a.zx,{variant:"danger",onClick:i,children:"\u79BB \u5F00"})]})]})]})}var oe=ue,ce=d(4096),R=d(25496),de=d(4387),ve=a.l0.useForm,G={DRAFT:"Draft",PUBLISHED:"Published"};function me(r){var i=r.isNew,u=r.onChange,o=(0,n.useCallback)(function(h,m){u(m)},[u]);return(0,e.jsxs)("div",{className:"article-settings",children:[(0,e.jsxs)(a.l0,{onValuesChange:o,component:!1,children:[(0,e.jsx)(a.l0.Item,{dependencies:["slug"],className:"mb-10",label:"\u94FE\u63A5\u5730\u5740",children:function(m){return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(a.l0.Item,{name:"slug",noStyle:!0,children:(0,e.jsx)(a.II,{size:"sm"})}),(0,e.jsxs)("p",{className:"mt-1 text-gray-600",children:["localhost:2368/",m.getFieldValue("slug"),"/"]})]})}}),(0,e.jsx)(a.l0.Item,{className:"mb-10",name:"publishedAt",label:"\u53D1\u5E03\u65F6\u95F4",children:(0,e.jsx)(a.Mt,{size:"sm"})}),(0,e.jsx)(a.l0.Item,{className:"mb-10",name:"tags",label:"\u6807\u7B7E",children:(0,e.jsx)(a.ub,{size:"sm"})}),(0,e.jsx)(a.l0.Item,{className:"mb-10",name:"access",label:"\u8BBF\u95EE\u6743\u9650",children:(0,e.jsx)(a.ub,{size:"sm",options:[{value:"public",label:"\u5B8C\u5168\u516C\u5F00"}]})}),(0,e.jsx)(a.l0.Item,{className:"mb-10",name:"summary",label:"\u6458\u8981",children:(0,e.jsx)(a.II.TextArea,{autoSize:{minRows:3}})}),(0,e.jsx)(a.l0.Item,{className:"mb-10",name:"author",label:"\u4F5C\u8005",children:(0,e.jsx)(a.II,{size:"sm"})})]}),!i&&(0,e.jsx)(a.zx,{icon:(0,e.jsx)(F.ZP,{name:"Duotune/arr015",className:"svg-icon-2"}),activeColor:"danger",variantStyle:"light",variant:"danger",className:"mb-10",children:"\u5220\u9664\u6587\u7AE0"})]})}function fe(r){var i=r.value,u=r.saved,o="\u8349\u7A3F - \u5DF2\u4FDD\u5B58";return u==="Saving"?o="\u4FDD\u5B58\u4E2D...":(i==="New"&&(o="\u65B0\u7684"),i==="Draft"&&(o="\u8349\u7A3F"+(u!="NotSaved"?" - \u5DF2\u4FDD\u5B58":""))),(0,e.jsx)("span",{className:"text-gray-600 ls-2",children:o})}function T(r,i){var u=r.model.document._getDefaultRange(),o=i.createSelection(u);return i.setSelection(o),o}function z(r){var i=r.history,u=r.loading,o=u===void 0?!1:u,h=ve(),m=(0,n.useRef)(null),p=(0,n.useRef)(null),y=(0,n.useRef)(null),E=(0,n.useRef)(null),w=(0,n.useReducer)(function(c){return c+1},0),M=(0,N.Z)(w,2),S=M[1],x=(0,n.useRef)({status:"New",saved:"Saved"}),g=(0,n.useState)(!0),B=(0,N.Z)(g,2),j=B[0],W=B[1],Ce=(0,n.useState)("BalloonBlockEditor"),V=(0,N.Z)(Ce,2),je=V[0],J=V[1],pe=(0,n.useState)(0),X=(0,N.Z)(pe,2),Ne=X[0],ye=X[1],Ee=(0,D.$C)(),P=Ee.data;P=P===void 0?{}:P;var Y=P.channels,Se=(0,n.useCallback)(function(c){ye(c.characters)},[]),Ae=(0,n.useMemo)(function(){return(Y||[]).map(function(c){return{label:c.fullName,value:c.id}})},[Y]);(0,n.useEffect)(function(){var c;if(!!r.data){var s=x.current;s.data=(0,v.Z)((0,v.Z)({},r.data),{},{channels:r.data.channels.map(function(A){return A.id})}),s.temp={},s.status=G[s.data.status],S();var t=(0,v.Z)((0,v.Z)({},s.data),{},{content:(c=s.data.content)===null||c===void 0?void 0:c.text});for(var l in t)t[l]==null&&(t[l]=void 0);h.setFieldsValue(t)}},[r.data]);var Be=(0,D.uw)({fetchPolicy:"network-only"}),be=(0,N.Z)(Be,1),Ze=be[0],Fe=(0,D.Mq)({fetchPolicy:"network-only"}),we=(0,N.Z)(Fe,1),ke=we[0],De=(0,de.Qk)(function(){var c=(0,U.Z)(k().mark(function s(t){var l,A,C,b,Z,$;return k().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(l=x.current,A=t.content?{type:"HTML",text:t.content}:void 0,f.prev=2,l.status!="New"){f.next=17;break}if(t.title){f.next=8;break}return l.saved="NotSaved",S(),f.abrupt("return");case 8:return f.next=10,(0,R.gw)(Ze({variables:{input:(0,v.Z)((0,v.Z)((0,v.Z)({},l.temp),t),{},{category:"news",content:A})}}),350);case 10:C=f.sent,b=C.data,l.data=(0,v.Z)((0,v.Z)({},b.article),{},{channels:b.article.channels.map(function(H){return H.id})}),l.temp={},l.status=G[b.article.status],f.next=22;break;case 17:return f.next=19,(0,R.gw)(ke({variables:{id:l.data.id,input:(0,v.Z)((0,v.Z)((0,v.Z)({},l.temp),t),{},{content:A})}}),350);case 19:Z=f.sent,$=Z.data,l.data=(0,v.Z)((0,v.Z)({},$.article),{},{channels:$.article.channels.map(function(H){return H.id})});case 22:f.next=28;break;case 24:f.prev=24,f.t0=f.catch(2),l.temp=t,console.error(f.t0);case 28:l.saved="Saved",S();case 30:case"end":return f.stop()}},s,null,[[2,24]])}));return function(s){return c.apply(this,arguments)}}(),{}),q=(0,N.Z)(De,2),I=q[0],Pe=q[1],Ie=(0,n.useCallback)(function(){if(i.length)return i.goBack();i.push("/cms/channels")},[i]),Re=(0,n.useCallback)(function(){var c=(0,U.Z)(k().mark(function s(t){var l;return k().wrap(function(C){for(;;)switch(C.prev=C.next){case 0:if(l=x.current,l.status!="New"){C.next=11;break}return l.saved="Saving",S(),C.next=6,(0,R.gw)(Promise.resolve((0,v.Z)((0,v.Z)({},l.temp),t)),350);case 6:l.temp=C.sent,l.saved="NotSaved",S(),C.next=12;break;case 11:I(t);case 12:case"end":return C.stop()}},s)}));return function(s){return c.apply(this,arguments)}}(),[I]),Te=(0,n.useCallback)(function(){W(function(c){return!c})},[]),ze=(0,n.useCallback)(function(c){c.preventDefault(),c.stopPropagation();var s=m.current;s&&s.model.change(function(t){if(s.focus(),s.getData().startsWith("<p>&nbsp;</p>"))return T(s,t);var l=T(s,t),A=t.createElement("paragraph"),C=t.createElement("paragraph"),b=t.createElement("p"),Z=t.createDocumentFragment();t.append(A,Z),t.append(b,Z),t.append(C,b),s.model.insertContent(Z,l),T(s,t)})},[]),Me=(0,n.useCallback)(function(c,s){var t=x.current;t.saved="NotSaved",S(),I(s)},[I]),We=(0,L.Z)(y),$e=(0,L.Z)(E),He=We||$e;return(0,e.jsx)(a.yC,{spinning:o,children:(0,e.jsxs)("div",{className:"tw-flex tw-flex-row modal-fullscreen art-main",children:[(0,e.jsx)(te(),{disableNative:!0,when:x.current.saved=="NotSaved",children:function(s){var t=s.onConfirm,l=s.onCancel;return(0,e.jsx)(oe,{onConfirm:t,onCancel:l})}}),(0,e.jsxs)("div",{className:"art-editor",children:[(0,e.jsxs)("div",{className:"art-editor-header",children:[(0,e.jsxs)("div",{className:"tw-flex tw-items-center pe-auto",children:[(0,e.jsx)(a.zx,{icon:(0,e.jsx)(F.ZP,{name:"Duotune/arr074",className:"svg-icon-2"}),variant:"white",onClick:Ie,children:"\u6587\u7AE0"}),(0,e.jsx)("div",{className:"art-editor-status px-6",children:(0,e.jsx)(fe,{value:x.current.status,saved:Pe?"Saving":x.current.saved})})]}),(0,e.jsxs)("div",{className:"tw-flex",children:[x.current.status!=="New"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(a.zx,{variant:"white",color:"primary",activeTextColor:"primary",className:"me-3",children:"\u9884\u89C8"}),(0,e.jsx)(a.zx,{variant:"white",className:K()({"me-3":j}),children:"\u53D1\u5E03"})]}),j&&(0,e.jsx)("div",{className:"settings-menu-toggle-spacer"})]})]}),(0,e.jsx)("div",{ref:p,className:"art-editor-body relative w-100 vh-100 overflow-x-hidden hover-scroll-overlay-y px-5",children:(0,e.jsxs)(a.l0,{form:h,initialValues:x.current.data||{},onValuesChange:Me,component:!1,children:[(0,e.jsx)("div",{ref:y,className:"art-editor-feature-image-container",children:(0,e.jsx)("div",{className:K()("tw-flex flex-row tw-items-center",{invisible:!He}),children:(0,e.jsx)(a.zx,{icon:(0,e.jsx)(F.ZP,{name:"Duotune/arr087",className:"svg-icon-2"}),type:"link",variant:!1,color:"muted",activeTextColor:"gray-700",flushed:!0,children:"\u6DFB\u52A0\u5C01\u9762\u56FE"})})}),(0,e.jsx)("div",{className:"art-editor-title",ref:E,children:(0,e.jsx)(a.l0.Item,{name:"title",noStyle:!0,children:(0,e.jsx)(a.II.TextArea,{autoSize:!0,bordered:!1,onPressEnter:ze,placeholder:"\u6587\u7AE0\u6807\u9898"})})}),(0,e.jsx)("div",{className:"art-editor-channel",children:(0,e.jsx)(a.l0.Item,{name:"channels",noStyle:!0,children:(0,e.jsx)(a.ub,{size:"sm",multiple:!0,placeholder:"\u9009\u62E9\u680F\u76EE",width:"auto",options:Ae})})}),(0,e.jsx)("div",{className:"art-editor-content",children:(0,e.jsx)(a.l0.Item,{name:"content",noStyle:!0,children:(0,e.jsx)(ie,{onWordCount:Se,editor:je,container:p,ref:m})})})]})}),(0,e.jsxs)("div",{className:"art-editor-switch-editor text-gray-500",children:[(0,e.jsx)("a",{onClick:function(){return J("ClassicEditor")},children:"\u7ECF\u5178"}),(0,e.jsx)("a",{onClick:function(){return J("BalloonBlockEditor")},children:"\u7B80\u6D01"})]}),(0,e.jsxs)("div",{className:"art-editor-wordcount-container",children:[(0,e.jsxs)("div",{id:"word-count",className:"art-editor-wordcount text-gray-500",children:[Ne," \u4E2A\u5B57\u7B26"]}),(0,e.jsx)(F.ZP,{name:"Duotune/art008",className:"svg-icon-4 px-2 py-2"})]})]}),!j&&(0,e.jsx)(ce.Z,{title:"\u6587\u7AE0\u8BBE\u7F6E",content:(0,e.jsx)(me,{isNew:x.current.status==="New",onChange:Re})}),(0,e.jsx)(a.zx,{className:"settings-menu-toggle",variant:"white",icon:(0,e.jsx)(F.ZP,{name:"Duotune/lay004",className:"svg-icon-2"}),onClick:Te})]})})}function he(r){return(0,e.jsx)(z,(0,v.Z)({},r))}function xe(r){var i=r.match.params.id,u=(0,n.useRef)(0),o=(0,D.V7)({variables:{id:i},fetchPolicy:"cache-and-network"}),h=o.data,m=o.loading,p=(0,n.useMemo)(function(){if(m){if(u.current==1)return!1;u.current++}return m},[m]);return(0,e.jsx)(z,(0,v.Z)((0,v.Z)({},r),{},{loading:p,data:h==null?void 0:h.article}))}var ge=z}}]);
